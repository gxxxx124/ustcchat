<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NSRLChat - çŸ¥è¯†åº“æ–‡ä»¶ç®¡ç†</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', 'Cantarell', sans-serif;
            background: #ffffff;
            color: #333;
            line-height: 1.6;
        }

        .header {
            background: #ffffff;
            border-bottom: 1px solid #e5e7eb;
            padding: 1rem 2rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header h1 {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 1.5rem;
            font-weight: 600;
            color: #111827;
        }

        .logo {
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, #00d4aa, #00a8cc);
            border-radius: 8px;
            color: white;
            font-weight: bold;
            font-size: 14px;
        }

        .nav-links {
            display: flex;
            gap: 1rem;
        }

        .nav-link {
            color: #6b7280;
            text-decoration: none;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            transition: all 0.2s;
        }

        .nav-link:hover {
            background: #f3f4f6;
            color: #111827;
        }

        .nav-link.active {
            background: #eff6ff;
            color: #2563eb;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
        }

        .upload-section {
            background: #ffffff;
            border: 1px solid #e5e7eb;
            border-radius: 12px;
            padding: 2rem;
            margin-bottom: 2rem;
        }

        .section-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: #111827;
            margin-bottom: 1rem;
        }

        .upload-area {
            border: 2px dashed #d1d5db;
            border-radius: 8px;
            padding: 3rem 2rem;
            text-align: center;
            background: #fafafa;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .upload-area:hover {
            border-color: #3b82f6;
            background: #f8faff;
        }

        .upload-area.dragover {
            border-color: #3b82f6;
            background: #eff6ff;
        }

        .upload-icon {
            font-size: 3rem;
            color: #9ca3af;
            margin-bottom: 1rem;
        }

        .upload-text {
            font-size: 1.1rem;
            color: #6b7280;
            margin-bottom: 0.5rem;
        }

        .upload-hint {
            font-size: 0.9rem;
            color: #9ca3af;
        }

        .file-input {
            display: none;
        }

        .file-list {
            margin-top: 1.5rem;
        }

        .file-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 1rem;
            background: #f9fafb;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            margin-bottom: 0.5rem;
        }

        .file-info {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .file-icon {
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #e5e7eb;
            border-radius: 6px;
            font-size: 0.9rem;
            color: #6b7280;
        }

        .file-details h4 {
            font-size: 0.9rem;
            font-weight: 500;
            color: #111827;
            margin-bottom: 0.25rem;
        }

        .file-details p {
            font-size: 0.8rem;
            color: #6b7280;
        }

        .file-actions {
            display: flex;
            gap: 0.5rem;
        }

        .btn {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 6px;
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-primary {
            background: #3b82f6;
            color: white;
        }

        .btn-primary:hover {
            background: #2563eb;
        }

        .btn-secondary {
            background: #f3f4f6;
            color: #374151;
        }

        .btn-secondary:hover {
            background: #e5e7eb;
        }

        .btn-danger {
            background: #ef4444;
            color: white;
        }

        .btn-danger:hover {
            background: #dc2626;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .progress-bar {
            width: 100%;
            height: 6px;
            background: #e5e7eb;
            border-radius: 3px;
            overflow: hidden;
            margin-top: 0.5rem;
        }

        .progress-fill {
            height: 100%;
            background: #3b82f6;
            transition: width 0.3s ease;
        }

        .progress-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 0.75rem;
            color: #374151;
            font-weight: 500;
        }

        .status-message {
            padding: 1rem;
            border-radius: 8px;
            margin-top: 1rem;
            font-size: 0.9rem;
        }

        .status-success {
            background: #f0fdf4;
            color: #166534;
            border: 1px solid #bbf7d0;
        }

        .status-error {
            background: #fef2f2;
            color: #dc2626;
            border: 1px solid #fecaca;
        }

        .status-info {
            background: #eff6ff;
            color: #1d4ed8;
            border: 1px solid #bfdbfe;
        }
        
        .status-warning {
            background-color: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        
        /* ä¸Šä¼ ç»“æœæ ·å¼ */
        .upload-results {
            margin-top: 20px;
            padding: 15px;
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
        }
        
        .upload-results h3 {
            margin: 0 0 15px 0;
            color: #495057;
            font-size: 18px;
        }
        
        .results-list {
            max-height: 300px;
            overflow-y: auto;
        }
        
        .result-item {
            display: flex;
            align-items: center;
            padding: 10px;
            margin-bottom: 8px;
            background-color: white;
            border-radius: 6px;
            border-left: 4px solid #28a745;
        }
        
        .result-item.error {
            border-left-color: #dc3545;
        }
        
        .result-item .result-icon {
            margin-right: 10px;
            font-size: 18px;
        }
        
        .result-item .result-content {
            flex: 1;
        }
        
        .result-item .result-filename {
            font-weight: bold;
            margin-bottom: 4px;
        }
        
        .result-item .result-message {
            color: #6c757d;
            font-size: 14px;
        }
        
        .result-item .result-time {
            color: #adb5bd;
            font-size: 12px;
        }
        
        .result-actions {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .result-actions .btn {
            padding: 4px 8px;
            font-size: 12px;
            min-width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .knowledge-base-info {
            margin-bottom: 1.5rem;
        }

        .kb-display {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.75rem;
            background: #f0fdf4;
            border: 1px solid #bbf7d0;
            border-radius: 6px;
        }

        .kb-name {
            font-weight: 600;
            color: #166534;
        }

        .kb-status {
            font-size: 0.9rem;
            color: #166534;
        }

        .form-group {
            margin-bottom: 1rem;
        }

        .form-label {
            display: block;
            font-size: 0.9rem;
            font-weight: 500;
            color: #374151;
            margin-bottom: 0.5rem;
        }

        .form-select {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            background: white;
            font-size: 0.9rem;
        }

        .form-select:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .supported-formats {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 1rem;
            margin-top: 1rem;
        }

        .supported-formats h4 {
            font-size: 0.9rem;
            font-weight: 600;
            color: #374151;
            margin-bottom: 0.5rem;
        }

        .format-list {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
        }

        .format-tag {
            background: #e0f2fe;
            color: #0277bd;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: 500;
        }

        .loading {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid #f3f3f3;
            border-top: 2px solid #3b82f6;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .hidden {
            display: none;
        }

        /* æ–‡æ¡£åˆ—è¡¨æ ·å¼ */
        .document-list {
            margin-top: 1rem;
        }

        .loading-state {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            padding: 2rem;
            color: #6b7280;
        }

        .document-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 1rem;
            background: #f9fafb;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            margin-bottom: 0.5rem;
            transition: all 0.2s ease;
        }

        .document-item:hover {
            background: #f3f4f6;
            border-color: #d1d5db;
        }

        .document-info {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            flex: 1;
            min-width: 0;
        }

        .document-icon {
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #e5e7eb;
            border-radius: 6px;
            font-size: 0.9rem;
            color: #6b7280;
            flex-shrink: 0;
        }

        .document-details {
            flex: 1;
            min-width: 0;
        }

        .document-name {
            font-size: 0.9rem;
            font-weight: 500;
            color: #111827;
            margin-bottom: 0.25rem;
            word-break: break-all;
        }

        .document-meta {
            font-size: 0.8rem;
            color: #6b7280;
            display: flex;
            gap: 1rem;
        }

        .document-actions {
            display: flex;
            gap: 0.5rem;
            flex-shrink: 0;
        }

        .btn-sm {
            padding: 0.375rem 0.75rem;
            font-size: 0.8rem;
        }

        .empty-documents {
            text-align: center;
            padding: 2rem;
            color: #6b7280;
        }

        .empty-documents .icon {
            font-size: 3rem;
            margin-bottom: 1rem;
            opacity: 0.5;
        }

        .refresh-btn {
            background: #f3f4f6;
            color: #374151;
            border: 1px solid #d1d5db;
        }

        .refresh-btn:hover {
            background: #e5e7eb;
            border-color: #9ca3af;
        }

        /* é¢„è§ˆæ¨¡æ€æ¡†æ ·å¼ */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
        }

        .modal-content {
            background-color: #ffffff;
            margin: 5% auto;
            padding: 0;
            border-radius: 12px;
            width: 90%;
            max-width: 800px;
            max-height: 80vh;
            overflow: hidden;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
        }

        .modal-header {
            padding: 1rem 1.5rem;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #f9fafb;
        }

        .modal-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: #111827;
            margin: 0;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #6b7280;
            padding: 0;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-close:hover {
            color: #374151;
        }

        .modal-body {
            padding: 1.5rem;
            max-height: 60vh;
            overflow-y: auto;
        }

        .preview-content {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', 'Cantarell', 'Fira Sans', 'Droid Sans', 'Helvetica Neue', sans-serif;
            font-size: 16px;
            line-height: 1.7;
            color: #1f2937;
            background: #ffffff;
            padding: 2rem;
            border-radius: 8px;
            border: 1px solid #e5e7eb;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        /* Markdownå†…å®¹æ ·å¼ä¼˜åŒ– */
        .preview-content h1 {
            font-size: 2rem;
            font-weight: 700;
            color: #111827;
            margin: 1.5rem 0 1rem 0;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid #e5e7eb;
        }

        .preview-content h2 {
            font-size: 1.5rem;
            font-weight: 600;
            color: #374151;
            margin: 1.25rem 0 0.75rem 0;
            padding-bottom: 0.25rem;
            border-bottom: 1px solid #e5e7eb;
        }

        .preview-content h3 {
            font-size: 1.25rem;
            font-weight: 600;
            color: #4b5563;
            margin: 1rem 0 0.5rem 0;
        }

        .preview-content p {
            margin: 0.75rem 0;
            color: #374151;
        }

        .preview-content ul, .preview-content ol {
            margin: 0.75rem 0;
            padding-left: 1.5rem;
        }

        .preview-content li {
            margin: 0.25rem 0;
            color: #374151;
        }

        .preview-content strong {
            font-weight: 600;
            color: #111827;
        }

        .preview-content em {
            font-style: italic;
            color: #4b5563;
        }

        .preview-content code {
            font-family: 'SF Mono', 'Monaco', 'Inconsolata', 'Roboto Mono', 'Source Code Pro', monospace;
            font-size: 0.875rem;
            background: #f3f4f6;
            color: #dc2626;
            padding: 0.125rem 0.375rem;
            border-radius: 4px;
            border: 1px solid #e5e7eb;
        }

        .preview-content pre {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            padding: 1rem;
            margin: 1rem 0;
            overflow-x: auto;
        }

        .preview-content pre code {
            background: none;
            color: #1e293b;
            padding: 0;
            border: none;
            font-size: 0.875rem;
        }

        .preview-content blockquote {
            border-left: 4px solid #3b82f6;
            background: #f8fafc;
            margin: 1rem 0;
            padding: 0.75rem 1rem;
            color: #4b5563;
            font-style: italic;
        }

        .preview-content table {
            width: 100%;
            border-collapse: collapse;
            margin: 1rem 0;
            background: white;
            border-radius: 6px;
            overflow: hidden;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .preview-content th {
            background: #f8fafc;
            font-weight: 600;
            color: #374151;
            padding: 0.75rem;
            text-align: left;
            border-bottom: 2px solid #e5e7eb;
        }

        .preview-content td {
            padding: 0.75rem;
            border-bottom: 1px solid #e5e7eb;
            color: #374151;
        }

        .preview-content tr:hover {
            background: #f9fafb;
        }

        .preview-content img {
            max-width: 100%;
            height: auto;
            border-radius: 6px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            margin: 0.5rem 0;
        }

        /* ä¸Šä¼ é˜Ÿåˆ—æ ·å¼ */
        .upload-queue {
            margin-top: 1rem;
        }

        .queue-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.75rem;
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            margin-bottom: 0.5rem;
        }

        .queue-item.uploading {
            background: #eff6ff;
            border-color: #3b82f6;
        }

        .queue-item.processing {
            background: #fffbeb;
            border-color: #f59e0b;
        }

        .queue-item.completed {
            background: #f0fdf4;
            border-color: #22c55e;
        }

        .queue-item.error {
            background: #fef2f2;
            border-color: #ef4444;
        }

        .queue-info {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            flex: 1;
        }

        .queue-status {
            font-size: 0.8rem;
            font-weight: 500;
        }

        .queue-status.uploading {
            color: #2563eb;
        }

        .queue-status.completed {
            color: #16a34a;
        }

        .queue-status.error {
            color: #dc2626;
        }

        .queue-progress {
            width: 100px;
            height: 4px;
            background: #e5e7eb;
            border-radius: 2px;
            overflow: hidden;
        }

        .queue-progress-fill {
            height: 100%;
            background: #3b82f6;
            transition: width 0.3s ease;
        }
    </style>
</head>
<body>
    <script>
        // è®¤è¯æ£€æŸ¥
        async function checkAuthStatus() {
            // ä¼˜å…ˆä»Cookieè·å–tokenï¼ˆCASç™»å½•ä½¿ç”¨Cookieï¼‰
            function getAccessToken() {
                // é¦–å…ˆå°è¯•ä»Cookieè·å–
                const cookies = document.cookie.split(';');
                for (let cookie of cookies) {
                    const trimmed = cookie.trim();
                    const equalIndex = trimmed.indexOf('=');
                    if (equalIndex === -1) continue;
                    
                    const name = trimmed.substring(0, equalIndex).trim();
                    const value = trimmed.substring(equalIndex + 1).trim();
                    
                    if (name === 'access_token' || name === 'access_token_root') {
                        let tokenValue = value;
                        // ç§»é™¤å¯èƒ½çš„å¼•å·
                        if ((tokenValue.startsWith('"') && tokenValue.endsWith('"')) || 
                            (tokenValue.startsWith("'") && tokenValue.endsWith("'"))) {
                            tokenValue = tokenValue.slice(1, -1);
                        }
                        // åŒæ—¶ä¿å­˜åˆ°localStorageï¼Œæ–¹ä¾¿åç»­ä½¿ç”¨
                        localStorage.setItem('access_token', tokenValue);
                        return tokenValue;
                    }
                }
                // å¦‚æœCookieä¸­æ²¡æœ‰ï¼Œå°è¯•ä»localStorageè·å–
                return localStorage.getItem('access_token');
            }
            
            const token = getAccessToken();
            if (!token) {
                // æ²¡æœ‰tokenï¼Œé‡å®šå‘åˆ°ç™»å½•é¡µé¢
                // è·å–åŸºç¡€è·¯å¾„ï¼Œæ”¯æŒå­è·¯å¾„éƒ¨ç½²
                let basePath = '';
                const path = window.location.pathname;
                if (path.startsWith('/nsrlchat')) {
                    basePath = '/nsrlchat';
                } else if (path.startsWith('/NSRLChat')) {
                    basePath = '/NSRLChat';
                } else {
                    basePath = window.location.pathname.replace(/\/[^\/]*$/, '');
                }
                window.location.href = basePath + '/auth/login-page';
                return;
            }
            
            try {
                // éªŒè¯tokenæ˜¯å¦æœ‰æ•ˆ
                // è·å–åŸºç¡€è·¯å¾„ï¼Œæ”¯æŒå­è·¯å¾„éƒ¨ç½²
                let basePath = '';
                const path = window.location.pathname;
                if (path.startsWith('/nsrlchat')) {
                    basePath = '/nsrlchat';
                } else if (path.startsWith('/NSRLChat')) {
                    basePath = '/NSRLChat';
                } else {
                    basePath = window.location.pathname.replace(/\/[^\/]*$/, '');
                }
                const response = await fetch(basePath + '/auth/me', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (!response.ok) {
                    // tokenæ— æ•ˆï¼Œæ¸…é™¤å¹¶é‡å®šå‘
                    localStorage.removeItem('access_token');
                    document.cookie = 'access_token=; path=/; expires=Thu, 01 Jan 1970 00:00:00 GMT';
                    // è·å–åŸºç¡€è·¯å¾„ï¼Œæ”¯æŒå­è·¯å¾„éƒ¨ç½²
                let basePath = '';
                const path = window.location.pathname;
                if (path.startsWith('/nsrlchat')) {
                    basePath = '/nsrlchat';
                } else if (path.startsWith('/NSRLChat')) {
                    basePath = '/NSRLChat';
                } else {
                    basePath = window.location.pathname.replace(/\/[^\/]*$/, '');
                }
                window.location.href = basePath + '/auth/login-page';
                    return;
                }
                
                const user = await response.json();
                
                // è°ƒè¯•ï¼šæ‰“å°ç”¨æˆ·ä¿¡æ¯
                console.log('=== æ–‡ä»¶ç®¡ç†é¡µé¢æƒé™æ£€æŸ¥ ===');
                console.log('ç”¨æˆ·ä¿¡æ¯:', JSON.stringify(user, null, 2));
                console.log('ç”¨æˆ·è§’è‰²ç±»å‹:', typeof user.role);
                console.log('ç”¨æˆ·è§’è‰²å€¼:', user.role);
                console.log('è§’è‰²æ˜¯å¦ç­‰äºcontributor:', user.role === 'contributor');
                console.log('è§’è‰²æ˜¯å¦ç­‰äºadmin:', user.role === 'admin');
                console.log('æ˜¯å¦ä¸ºç®¡ç†å‘˜:', user.is_admin);
                
                // æ£€æŸ¥æ˜¯å¦ä¸ºçŸ¥è¯†åº“è´¡çŒ®è€…æˆ–ç®¡ç†å‘˜
                // ä½¿ç”¨æ›´å®½æ¾çš„æ£€æŸ¥ï¼Œæ”¯æŒå­—ç¬¦ä¸²å’Œå¯èƒ½çš„å…¶ä»–æ ¼å¼
                const userRole = String(user.role || '').toLowerCase().trim();
                const isContributor = userRole === 'contributor';
                const isAdmin = userRole === 'admin';
                
                console.log('è§„èŒƒåŒ–åçš„è§’è‰²:', userRole);
                console.log('æ˜¯å¦ä¸ºè´¡çŒ®è€…:', isContributor);
                console.log('æ˜¯å¦ä¸ºç®¡ç†å‘˜:', isAdmin);
                
                if (!isContributor && !isAdmin) {
                    console.error('æƒé™æ£€æŸ¥å¤±è´¥ - ç”¨æˆ·è§’è‰²:', user.role, 'ç±»å‹:', typeof user.role, 'è§„èŒƒåŒ–å:', userRole);
                    alert('æƒé™ä¸è¶³ï¼šåªæœ‰çŸ¥è¯†åº“è´¡çŒ®è€…å’Œç®¡ç†å‘˜æ‰èƒ½è®¿é—®æ–‡ä»¶ç®¡ç†é¡µé¢ã€‚\nå½“å‰è§’è‰²: ' + (user.role || 'æœªè®¾ç½®') + '\nè¯·åˆ·æ–°é¡µé¢é‡è¯•ï¼Œæˆ–è”ç³»ç®¡ç†å‘˜ã€‚');
                    window.location.href = getBasePath() + '/';
                    return;
                }
                
                console.log('æƒé™æ£€æŸ¥é€šè¿‡ï¼Œå½“å‰ç”¨æˆ·:', user.username, 'è§’è‰²:', user.role);
                
            } catch (error) {
                console.error('è®¤è¯æ£€æŸ¥å¤±è´¥:', error);
                localStorage.removeItem('access_token');
                document.cookie = 'access_token=; path=/; expires=Thu, 01 Jan 1970 00:00:00 GMT';
                // è·å–åŸºç¡€è·¯å¾„ï¼Œæ”¯æŒå­è·¯å¾„éƒ¨ç½²
                let basePath = '';
                const path = window.location.pathname;
                if (path.startsWith('/nsrlchat')) {
                    basePath = '/nsrlchat';
                } else if (path.startsWith('/NSRLChat')) {
                    basePath = '/NSRLChat';
                } else {
                    basePath = window.location.pathname.replace(/\/[^\/]*$/, '');
                }
                window.location.href = basePath + '/auth/login-page';
            }
        }

        // é¡µé¢åŠ è½½æ—¶æ£€æŸ¥è®¤è¯
        window.addEventListener('load', checkAuthStatus);

        // å¯¼èˆªå‡½æ•°
        function goToChat() {
            window.location.href = getBasePath() + '/';
        }

        function goToUpload() {
            window.location.href = getBasePath() + '/upload.html';
        }

        // è·å–åŸºç¡€è·¯å¾„çš„å‡½æ•°
        function getBasePath() {
            const path = window.location.pathname;
            if (path.startsWith('/nsrlchat')) {
                return '/nsrlchat';
            } else if (path.startsWith('/NSRLChat')) {
                return '/NSRLChat';
            } else {
                return '';
            }
        }

        // å¸¦è®¤è¯çš„fetchå‡½æ•°
        async function authenticatedFetch(url, options = {}) {
            const token = localStorage.getItem('access_token');
            if (!token) {
                throw new Error('æœªæ‰¾åˆ°è®¤è¯tokenï¼Œè¯·é‡æ–°ç™»å½•');
            }
            
            // å¤„ç†ç›¸å¯¹è·¯å¾„
            if (url.startsWith('./')) {
                url = getBasePath() + url.substring(1);
            } else if (url.startsWith('/kb/') || url.startsWith('/auth/') || url.startsWith('/agent/')) {
                url = getBasePath() + url;
            }
            
            const headers = {
                'Authorization': `Bearer ${token}`,
                ...options.headers
            };
            
            const response = await fetch(url, {
                ...options,
                headers
            });
            
            // æ£€æŸ¥æ˜¯å¦æ˜¯è®¤è¯é”™è¯¯
            if (response.status === 401) {
                localStorage.removeItem('access_token');
                document.cookie = 'access_token=; path=/; expires=Thu, 01 Jan 1970 00:00:00 GMT';
                throw new Error('è®¤è¯å·²è¿‡æœŸï¼Œè¯·é‡æ–°ç™»å½•');
            }
            
            return response;
        }
    </script>
    <div class="header">
        <h1>
            <div class="logo">NSRL</div>
            NSRLChat - çŸ¥è¯†åº“ç®¡ç†
        </h1>
        <div class="nav-links">
            <a href="javascript:void(0)" onclick="goToChat()" class="nav-link">è¿”å›èŠå¤©</a>
            <a href="javascript:void(0)" onclick="goToUpload()" class="nav-link active">æ–‡ä»¶ç®¡ç†</a>
        </div>
    </div>

    <div class="container">
        <!-- æ–‡ä»¶ä¸Šä¼ åŒºåŸŸ -->
        <div class="upload-section">
            <h2 class="section-title">ä¸Šä¼ æ–‡ä»¶</h2>
            <div class="upload-area" id="uploadArea">
                <div class="upload-icon">ğŸ“</div>
                <div class="upload-text">ç‚¹å‡»æˆ–æ‹–æ‹½æ–‡ä»¶åˆ°æ­¤å¤„ä¸Šä¼ </div>
                <div class="upload-hint">æ”¯æŒ PDFã€MDã€Wordã€TXT ç­‰æ ¼å¼</div>
                <input type="file" id="fileInput" class="file-input" multiple accept=".pdf,.md,.txt,.docx">
            </div>

            <div class="supported-formats">
                <h4>æ”¯æŒçš„æ–‡ä»¶æ ¼å¼</h4>
                <div class="format-list">
                    <span class="format-tag">PDF</span>
                    <span class="format-tag">Markdown (.md)</span>
                    <span class="format-tag">Word (.docx)</span>
                    <span class="format-tag">çº¯æ–‡æœ¬ (.txt)</span>
                </div>
            </div>

            <div id="fileList" class="file-list"></div>
        </div>

        <!-- ä¸Šä¼ é˜Ÿåˆ— -->
        <div class="upload-section" id="uploadQueueSection" style="display: none;">
            <h2 class="section-title">ä¸Šä¼ é˜Ÿåˆ—</h2>
            <div class="upload-queue" id="uploadQueue">
                <!-- é˜Ÿåˆ—é¡¹ç›®å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
            </div>
        </div>

        <!-- çŠ¶æ€æ¶ˆæ¯ -->
        <div id="statusMessage" class="status-message hidden"></div>
        
        <!-- ä¸Šä¼ ç»“æœæ˜¾ç¤ºåŒºåŸŸ -->
        <div id="uploadResults" class="upload-results hidden">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                <h3 style="margin: 0;">ä¸Šä¼ ç»“æœ</h3>
                <button class="btn btn-sm btn-secondary" onclick="clearAllUploadResults()" title="æ¸…ç©ºæ‰€æœ‰ç»“æœ">
                    ğŸ—‘ï¸ æ¸…ç©º
                </button>
            </div>
            <div id="resultsList" class="results-list"></div>
        </div>

        <!-- çŸ¥è¯†åº“ä¿¡æ¯ -->
        <div class="upload-section">
            <h2 class="section-title">ç›®æ ‡çŸ¥è¯†åº“</h2>
            <div class="knowledge-base-info">
                <div class="form-group">
                    <label class="form-label">å½“å‰çŸ¥è¯†åº“</label>
                    <div class="kb-display">
                        <span class="kb-name" id="currentKbName">åŠ è½½ä¸­...</span>
                        <span class="kb-status" id="currentKbStatus">â³ æ£€æŸ¥è¿æ¥</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- æ–‡æ¡£åˆ—è¡¨ -->
        <div class="upload-section">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                <h2 class="section-title" style="margin: 0;">æ–‡æ¡£åˆ—è¡¨</h2>
                <button class="btn btn-sm refresh-btn" onclick="loadDocuments()">
                    <span>ğŸ”„</span>
                    åˆ·æ–°
                </button>
            </div>
            <div class="document-list" id="documentList">
                <div class="loading-state">
                    <div class="loading"></div>
                    <span>åŠ è½½æ–‡æ¡£åˆ—è¡¨ä¸­...</span>
                </div>
            </div>
        </div>
    </div>

    <!-- é¢„è§ˆæ¨¡æ€æ¡† -->
    <div id="previewModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="previewTitle">æ–‡æ¡£é¢„è§ˆ</h3>
                <button class="modal-close" onclick="closePreview()">&times;</button>
            </div>
            <div class="modal-body">
                <div id="previewContent" class="preview-content">åŠ è½½ä¸­...</div>
            </div>
        </div>
    </div>

    <script>
        // å†…è”Markdownè§£æå™¨ï¼Œé¿å…è·¯å¾„é—®é¢˜
        function parseMarkdown(text) {
            if (!text) return '';
            
            let html = text;
            
            // è½¬ä¹‰HTMLç‰¹æ®Šå­—ç¬¦
            html = html.replace(/&/g, '&amp;')
                       .replace(/</g, '&lt;')
                       .replace(/>/g, '&gt;');
            
            // æ ‡é¢˜
            html = html.replace(/^### (.*$)/gim, '<h3>$1</h3>');
            html = html.replace(/^## (.*$)/gim, '<h2>$1</h2>');
            html = html.replace(/^# (.*$)/gim, '<h1>$1</h1>');
            
            // ç²—ä½“å’Œæ–œä½“
            html = html.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            html = html.replace(/\*(.*?)\*/g, '<em>$1</em>');
            
            // ä»£ç å—
            html = html.replace(/```([\s\S]*?)```/g, '<pre><code>$1</code></pre>');
            html = html.replace(/`([^`]+)`/g, '<code>$1</code>');
            
            // é“¾æ¥
            html = html.replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2" target="_blank">$1</a>');
            
            // åˆ—è¡¨
            html = html.replace(/^\* (.+)$/gim, '<li>$1</li>');
            html = html.replace(/^- (.+)$/gim, '<li>$1</li>');
            html = html.replace(/^(\d+)\. (.+)$/gim, '<li>$1. $2</li>');
            
            // åŒ…è£…åˆ—è¡¨é¡¹
            html = html.replace(/(<li>.*<\/li>)/gs, '<ul>$1</ul>');
            
            // æ®µè½
            html = html.replace(/\n\n/g, '</p><p>');
            html = '<p>' + html + '</p>';
            
            // æ¢è¡Œ
            html = html.replace(/\n/g, '<br>');
            
            // æ¸…ç†ç©ºæ®µè½
            html = html.replace(/<p><\/p>/g, '');
            html = html.replace(/<p><br><\/p>/g, '');
            
            return html;
        }
        
        // å…¼å®¹marked.parseçš„æ¥å£
        window.marked = {
            parse: parseMarkdown
        };
    </script>
    <script>
        let selectedFiles = [];
        let uploadQueue = [];
        let isUploading = false;
        let currentKnowledgeBase = 'NSRLæŠ€æœ¯æ–‡æ¡£åº“'; // çŸ¥è¯†åº“åç§°

        // åˆå§‹åŒ–é¡µé¢
        document.addEventListener('DOMContentLoaded', function() {
            setupFileUpload();
            loadKnowledgeBaseInfo();
            loadDocuments();
        });

        // åŠ è½½çŸ¥è¯†åº“ä¿¡æ¯
        async function loadKnowledgeBaseInfo() {
            try {
                const response = await authenticatedFetch('./kb/api/knowledge-bases');
                const data = await response.json();
                
                if (data.success && data.data.knowledge_bases.length > 0) {
                    // æ‰¾åˆ°NSRLæŠ€æœ¯æ–‡æ¡£åº“
                    const nsrlKb = data.data.knowledge_bases.find(kb => kb.name === 'NSRLæŠ€æœ¯æ–‡æ¡£åº“');
                    if (nsrlKb) {
                        // æ›´æ–°é¡µé¢æ˜¾ç¤º
                        document.getElementById('currentKbName').textContent = nsrlKb.name;
                        document.getElementById('currentKbStatus').textContent = 'âœ… å·²è¿æ¥';
                        document.getElementById('currentKbStatus').className = 'kb-status';
                    } else {
                        // å¦‚æœæ²¡æœ‰æ‰¾åˆ°ï¼Œæ˜¾ç¤ºé»˜è®¤ä¿¡æ¯
                        document.getElementById('currentKbName').textContent = 'NSRLæŠ€æœ¯æ–‡æ¡£åº“';
                        document.getElementById('currentKbStatus').textContent = 'âŒ æœªæ‰¾åˆ°';
                        document.getElementById('currentKbStatus').className = 'kb-status error';
                    }
                } else {
                    // å¦‚æœAPIè°ƒç”¨å¤±è´¥ï¼Œæ˜¾ç¤ºé»˜è®¤ä¿¡æ¯
                    document.getElementById('currentKbName').textContent = 'NSRLæŠ€æœ¯æ–‡æ¡£åº“';
                    document.getElementById('currentKbStatus').textContent = 'âŒ è¿æ¥å¤±è´¥';
                    document.getElementById('currentKbStatus').className = 'kb-status error';
                }
            } catch (error) {
                console.error('åŠ è½½çŸ¥è¯†åº“ä¿¡æ¯å¤±è´¥:', error);
                document.getElementById('currentKbName').textContent = 'NSRLæŠ€æœ¯æ–‡æ¡£åº“';
                document.getElementById('currentKbStatus').textContent = 'âŒ è¿æ¥å¤±è´¥';
                document.getElementById('currentKbStatus').className = 'kb-status error';
            }
        }

        // è®¾ç½®æ–‡ä»¶ä¸Šä¼ 
        function setupFileUpload() {
            const uploadArea = document.getElementById('uploadArea');
            const fileInput = document.getElementById('fileInput');

            // ç‚¹å‡»ä¸Šä¼ åŒºåŸŸ
            uploadArea.addEventListener('click', () => {
                fileInput.click();
            });

            // æ–‡ä»¶é€‰æ‹©
            fileInput.addEventListener('change', handleFileSelect);

            // æ‹–æ‹½ä¸Šä¼ 
            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.classList.add('dragover');
            });

            uploadArea.addEventListener('dragleave', () => {
                uploadArea.classList.remove('dragover');
            });

            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
                const files = Array.from(e.dataTransfer.files);
                handleFiles(files);
            });
        }

        // å¤„ç†æ–‡ä»¶é€‰æ‹©
        function handleFileSelect(e) {
            const files = Array.from(e.target.files);
            handleFiles(files);
        }

        // å¤„ç†æ–‡ä»¶
        function handleFiles(files) {
            console.log('å¤„ç†æ–‡ä»¶:', files);
            files.forEach(file => {
                if (isValidFile(file)) {
                    const fileItem = {
                        file: file,
                        id: String(Date.now() + Math.random()),
                        status: 'pending',
                        progress: 0
                    };
                    console.log('åˆ›å»ºæ–‡ä»¶é¡¹:', fileItem);
                    selectedFiles.push(fileItem);
                    addToUploadQueue(fileItem);
                } else {
                    showStatus(`ä¸æ”¯æŒçš„æ–‡ä»¶æ ¼å¼: ${file.name}`, 'error');
                }
            });
            console.log('æ‰€æœ‰é€‰ä¸­çš„æ–‡ä»¶:', selectedFiles);
            updateFileList();
            updateUploadQueue();
        }

        // éªŒè¯æ–‡ä»¶æ ¼å¼
        function isValidFile(file) {
            const validExtensions = ['.pdf', '.md', '.txt', '.docx'];
            const fileName = file.name.toLowerCase();
            return validExtensions.some(ext => fileName.endsWith(ext));
        }

        // æ›´æ–°æ–‡ä»¶åˆ—è¡¨æ˜¾ç¤º
        function updateFileList() {
            const fileList = document.getElementById('fileList');
            fileList.innerHTML = '';

            selectedFiles.forEach(fileItem => {
                const fileDiv = document.createElement('div');
                fileDiv.className = 'file-item';
                fileDiv.innerHTML = `
                    <div class="file-info">
                        <div class="file-icon">${getFileIcon(fileItem.file.name)}</div>
                        <div class="file-details">
                            <h4>${fileItem.file.name}</h4>
                            <p>${formatFileSize(fileItem.file.size)}</p>
                        </div>
                    </div>
                    <div class="file-actions">
                        <button class="btn btn-primary" onclick="uploadFile('${fileItem.id}')" ${fileItem.status === 'uploading' || fileItem.status === 'processing' ? 'disabled' : ''}>
                            ${fileItem.status === 'uploading' ? '<span class="loading"></span> ä¸Šä¼ ä¸­' : 
                              fileItem.status === 'processing' ? '<span class="loading"></span> å¤„ç†ä¸­' :
                              fileItem.status === 'completed' ? 'âœ… å®Œæˆ' :
                              fileItem.status === 'error' ? 'âŒ å¤±è´¥' : 'ä¸Šä¼ '}
                        </button>
                        <button class="btn btn-danger" onclick="removeFile('${fileItem.id}')" ${fileItem.status === 'uploading' || fileItem.status === 'processing' ? 'disabled' : ''}>åˆ é™¤</button>
                    </div>
                    <div class="progress-bar" style="display: ${fileItem.status === 'uploading' || fileItem.status === 'processing' ? 'block' : 'none'}">
                        <div class="progress-fill" style="width: ${fileItem.progress}%"></div>
                        <div class="progress-text">${fileItem.status === 'uploading' ? 'ğŸ“¤ ä¸Šä¼ ä¸­...' : fileItem.status === 'processing' ? 'âš™ï¸ å¤„ç†ä¸­...' : ''}</div>
                    </div>
                `;
                fileList.appendChild(fileDiv);
            });
        }

        // è·å–æ–‡ä»¶å›¾æ ‡
        function getFileIcon(fileName) {
            const ext = fileName.toLowerCase().split('.').pop();
            const icons = {
                'pdf': 'ğŸ“„',
                'md': 'ğŸ“',
                'txt': 'ğŸ“„',
                'doc': 'ğŸ“„',
                'docx': 'ğŸ“„'
            };
            return icons[ext] || 'ğŸ“„';
        }

        // æ ¼å¼åŒ–æ–‡ä»¶å¤§å°
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        // ä¸Šä¼ æ–‡ä»¶
        async function uploadFile(fileId) {
            console.log('å°è¯•ä¸Šä¼ æ–‡ä»¶ï¼ŒID:', fileId, 'ç±»å‹:', typeof fileId);
            console.log('å½“å‰é€‰ä¸­çš„æ–‡ä»¶:', selectedFiles);
            const fileItem = selectedFiles.find(f => String(f.id) === String(fileId));
            if (!fileItem) {
                console.error('æ‰¾ä¸åˆ°æ–‡ä»¶ï¼ŒID:', fileId);
                showStatus('æ–‡ä»¶ä¸å­˜åœ¨', 'error');
                return;
            }
            console.log('æ‰¾åˆ°æ–‡ä»¶:', fileItem);

            // ä»é€‰æ‹©æ¡†ä¸­ç§»é™¤æ–‡ä»¶
            selectedFiles = selectedFiles.filter(f => String(f.id) !== String(fileId));
            updateFileList(); // æ›´æ–°é€‰æ‹©æ¡†æ˜¾ç¤º

            // ç«‹å³è®¾ç½®çŠ¶æ€ä¸ºç­‰å¾…ä¸­
            fileItem.status = 'pending';
            
            // æ·»åŠ åˆ°ä¸Šä¼ é˜Ÿåˆ—
            addToUploadQueue(fileItem);
            console.log('æ·»åŠ åˆ°é˜Ÿåˆ—åï¼Œé˜Ÿåˆ—å†…å®¹:', uploadQueue);
            
            // æ˜¾ç¤ºä¸Šä¼ é˜Ÿåˆ—åŒºåŸŸ
            const uploadQueueSection = document.getElementById('uploadQueueSection');
            uploadQueueSection.style.display = 'block';
            console.log('æ˜¾ç¤ºé˜Ÿåˆ—åŒºåŸŸ');
            
            // æ›´æ–°é˜Ÿåˆ—æ˜¾ç¤º
            updateUploadQueue();
            console.log('æ›´æ–°é˜Ÿåˆ—æ˜¾ç¤ºå®Œæˆ');
            
            // å»¶è¿Ÿä¸€ä¸‹å†å¼€å§‹å¤„ç†é˜Ÿåˆ—ï¼Œè®©ç”¨æˆ·èƒ½çœ‹åˆ°é˜Ÿåˆ—çŠ¶æ€
            setTimeout(() => {
                processUploadQueue();
            }, 1000);
        }

        // æ·»åŠ ä¸Šä¼ é˜Ÿåˆ—
        function addToUploadQueue(fileItem) {
            if (!uploadQueue.find(item => item.id === fileItem.id)) {
                uploadQueue.push(fileItem);
            }
        }

        // å¤„ç†ä¸Šä¼ é˜Ÿåˆ—
        async function processUploadQueue() {
            if (isUploading || uploadQueue.length === 0) {
                console.log('è·³è¿‡é˜Ÿåˆ—å¤„ç†ï¼ŒisUploading:', isUploading, 'é˜Ÿåˆ—é•¿åº¦:', uploadQueue.length);
                return;
            }

            console.log('å¼€å§‹å¤„ç†é˜Ÿåˆ—ï¼Œé˜Ÿåˆ—é•¿åº¦:', uploadQueue.length);
            isUploading = true;
            const uploadQueueSection = document.getElementById('uploadQueueSection');
            uploadQueueSection.style.display = 'block';

            // é€ä¸ªå¤„ç†é˜Ÿåˆ—ä¸­çš„æ–‡ä»¶ï¼Œè€Œä¸æ˜¯ä¸€æ¬¡æ€§å¤„ç†å®Œ
            const processNext = async () => {
                if (uploadQueue.length === 0) {
                    isUploading = false;
                    console.log('é˜Ÿåˆ—å¤„ç†å®Œæˆ');
                    return;
                }

                // æ‰¾åˆ°ç¬¬ä¸€ä¸ªç­‰å¾…ä¸­çš„æ–‡ä»¶
                const pendingIndex = uploadQueue.findIndex(item => item.status === 'pending');
                if (pendingIndex === -1) {
                    // æ²¡æœ‰ç­‰å¾…ä¸­çš„æ–‡ä»¶ï¼Œæ£€æŸ¥æ˜¯å¦è¿˜æœ‰å¤„ç†ä¸­çš„æ–‡ä»¶
                    const processingIndex = uploadQueue.findIndex(item => 
                        item.status === 'uploading' || item.status === 'processing'
                    );
                    if (processingIndex === -1) {
                        // æ‰€æœ‰æ–‡ä»¶éƒ½å¤„ç†å®Œäº†ï¼Œç»“æŸ
                        isUploading = false;
                        console.log('é˜Ÿåˆ—å¤„ç†å®Œæˆ');
                        return;
                    }
                    // è¿˜æœ‰å¤„ç†ä¸­çš„æ–‡ä»¶ï¼Œç­‰å¾…ä¸€ä¸‹å†æ£€æŸ¥
                    setTimeout(processNext, 1000);
                    return;
                }

                const fileItem = uploadQueue[pendingIndex];
                console.log('å¤„ç†é˜Ÿåˆ—ä¸­çš„æ–‡ä»¶:', fileItem.file.name);
                
                // å¤„ç†æ–‡ä»¶ï¼ˆä¸ç§»é™¤ï¼Œè®©æ–‡ä»¶ä¿æŒåœ¨é˜Ÿåˆ—ä¸­æ˜¾ç¤ºçŠ¶æ€ï¼‰
                await uploadSingleFile(fileItem);
                
                // å¤„ç†å®Œæˆåï¼Œå»¶è¿Ÿä¸€ä¸‹å†å¤„ç†ä¸‹ä¸€ä¸ªï¼Œè®©ç”¨æˆ·èƒ½çœ‹åˆ°çŠ¶æ€å˜åŒ–
                setTimeout(processNext, 1000);
            };

            // å¼€å§‹å¤„ç†ç¬¬ä¸€ä¸ªæ–‡ä»¶
            processNext();
        }

        // ä¸Šä¼ å•ä¸ªæ–‡ä»¶
        async function uploadSingleFile(fileItem) {
            fileItem.status = 'uploading';
            fileItem.progress = 0;
            updateUploadQueue();

            try {
                const formData = new FormData();
                formData.append('file', fileItem.file);
                formData.append('knowledge_base', currentKnowledgeBase);

                // å¼€å§‹ä¸Šä¼ 
                fileItem.progress = 10;
                updateUploadQueue();

                const response = await authenticatedFetch('./kb/api/upload-file', {
                    method: 'POST',
                    body: formData
                });

                // æ£€æŸ¥å“åº”çŠ¶æ€
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                // æ£€æŸ¥å“åº”å†…å®¹ç±»å‹
                const contentType = response.headers.get('content-type');
                if (!contentType || !contentType.includes('application/json')) {
                    const text = await response.text();
                    throw new Error(`æœåŠ¡å™¨è¿”å›äº†éJSONå“åº”: ${text.substring(0, 200)}...`);
                }

                // ä¸Šä¼ å®Œæˆï¼Œå¼€å§‹å¤„ç†
                fileItem.status = 'processing';
                fileItem.progress = 50;
                updateUploadQueue();

                const result = await response.json();

                if (result.success) {
                    // çœŸæ­£å¤„ç†å®Œæˆ
                    fileItem.status = 'completed';
                    fileItem.progress = 100;
                    updateUploadQueue();
                    
                    showStatus(`æ–‡ä»¶ ${fileItem.file.name} å¤„ç†å®Œæˆ`, 'success');
                    addUploadResult(fileItem.file.name, true, 'ä¸Šä¼ æˆåŠŸ');
                    loadDocuments(); // ä¸Šä¼ æˆåŠŸååˆ·æ–°æ–‡æ¡£åˆ—è¡¨
                    
                    // å»¶è¿Ÿä»é˜Ÿåˆ—ä¸­ç§»é™¤å·²å®Œæˆçš„æ–‡ä»¶ï¼Œè®©ç”¨æˆ·çœ‹åˆ°å®ŒæˆçŠ¶æ€
                    setTimeout(() => {
                        removeFileFromQueue(fileItem.id);
                    }, 3000); // 3ç§’åç§»é™¤
                } else {
                    // å¤„ç†å¤±è´¥
                    fileItem.status = 'error';
                    fileItem.progress = 100;
                    updateUploadQueue();
                    
                    showStatus(`å¤„ç†å¤±è´¥: ${result.message}`, 'error');
                    addUploadResult(fileItem.file.name, false, result.message);
                    
                    // å»¶è¿Ÿä»é˜Ÿåˆ—ä¸­ç§»é™¤å¤±è´¥çš„æ–‡ä»¶ï¼Œè®©ç”¨æˆ·çœ‹åˆ°å¤±è´¥çŠ¶æ€
                    setTimeout(() => {
                        removeFileFromQueue(fileItem.id);
                    }, 3000); // 3ç§’åç§»é™¤
                }
            } catch (error) {
                // ç½‘ç»œé”™è¯¯æˆ–å…¶ä»–å¼‚å¸¸
                fileItem.status = 'error';
                fileItem.progress = 100;
                updateUploadQueue();
                
                showStatus(`å¤„ç†å¤±è´¥: ${error.message}`, 'error');
                addUploadResult(fileItem.file.name, false, error.message);
                
                // å»¶è¿Ÿä»é˜Ÿåˆ—ä¸­ç§»é™¤å¤±è´¥çš„æ–‡ä»¶ï¼Œè®©ç”¨æˆ·çœ‹åˆ°å¤±è´¥çŠ¶æ€
                setTimeout(() => {
                    removeFileFromQueue(fileItem.id);
                }, 3000); // 3ç§’åç§»é™¤
            }
        }

        // åˆ é™¤æ–‡ä»¶
        function removeFile(fileId) {
            selectedFiles = selectedFiles.filter(f => String(f.id) !== String(fileId));
            uploadQueue = uploadQueue.filter(f => String(f.id) !== String(fileId));
            updateFileList();
            updateUploadQueue();
        }

        // ä»é˜Ÿåˆ—ä¸­ç§»é™¤æ–‡ä»¶
        function removeFileFromQueue(fileId) {
            uploadQueue = uploadQueue.filter(f => String(f.id) !== String(fileId));
            updateUploadQueue();
        }

        // æ›´æ–°ä¸Šä¼ é˜Ÿåˆ—æ˜¾ç¤º
        function updateUploadQueue() {
            console.log('æ›´æ–°é˜Ÿåˆ—æ˜¾ç¤ºï¼Œå½“å‰é˜Ÿåˆ—é•¿åº¦:', uploadQueue.length);
            const uploadQueueElement = document.getElementById('uploadQueue');
            if (uploadQueue.length === 0) {
                uploadQueueElement.innerHTML = '<p style="text-align: center; color: #6b7280; padding: 1rem;">é˜Ÿåˆ—ä¸ºç©º</p>';
                return;
            }

            const queueHTML = uploadQueue.map(item => `
                <div class="queue-item ${item.status}">
                    <div class="queue-info">
                        <span>${item.file.name}</span>
                        <span class="queue-status ${item.status}">
                            ${item.status === 'pending' ? 'â³ ç­‰å¾…ä¸­' : 
                              item.status === 'uploading' ? 'ğŸ“¤ ä¸Šä¼ ä¸­' :
                              item.status === 'processing' ? 'âš™ï¸ å¤„ç†ä¸­' :
                              item.status === 'completed' ? 'âœ… å·²å®Œæˆ' : 'âŒ å¤±è´¥'}
                        </span>
                    </div>
                    <div class="queue-progress">
                        <div class="queue-progress-fill" style="width: ${item.progress}%"></div>
                    </div>
                </div>
            `).join('');
            
            console.log('ç”Ÿæˆçš„é˜Ÿåˆ—HTML:', queueHTML);
            uploadQueueElement.innerHTML = queueHTML;
        }

        // é¢„è§ˆæ–‡æ¡£
        async function previewDocument(documentName) {
            const modal = document.getElementById('previewModal');
            const title = document.getElementById('previewTitle');
            const content = document.getElementById('previewContent');
            
            title.textContent = `é¢„è§ˆ: ${documentName}`;
            content.textContent = 'åŠ è½½ä¸­...';
            modal.style.display = 'block';

            try {
                const response = await authenticatedFetch(`./kb/api/document/${encodeURIComponent(currentKnowledgeBase)}/${encodeURIComponent(documentName)}/preview`);
                const data = await response.json();

                if (data.success) {
                    // ä½¿ç”¨Markdownè§£æå™¨æ¸²æŸ“å†…å®¹
                    content.innerHTML = marked.parse(data.data.content);
                } else {
                    content.textContent = `é¢„è§ˆå¤±è´¥: ${data.message}`;
                }
            } catch (error) {
                console.error('é¢„è§ˆå¤±è´¥:', error);
                content.textContent = `é¢„è§ˆå¤±è´¥: ${error.message}`;
            }
        }

        // å…³é—­é¢„è§ˆ
        function closePreview() {
            const modal = document.getElementById('previewModal');
            modal.style.display = 'none';
        }

        // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
        window.onclick = function(event) {
            const modal = document.getElementById('previewModal');
            if (event.target === modal) {
                closePreview();
            }
        }

        // æ˜¾ç¤ºçŠ¶æ€æ¶ˆæ¯
        function showStatus(message, type) {
            const statusDiv = document.getElementById('statusMessage');
            statusDiv.textContent = message;
            statusDiv.className = `status-message status-${type}`;
            statusDiv.classList.remove('hidden');

            setTimeout(() => {
                statusDiv.classList.add('hidden');
            }, 5000);
        }
        
        // æ·»åŠ ä¸Šä¼ ç»“æœ
        function addUploadResult(filename, success, message) {
            const resultsDiv = document.getElementById('uploadResults');
            const resultsList = document.getElementById('resultsList');
            
            // æ˜¾ç¤ºç»“æœåŒºåŸŸ
            resultsDiv.classList.remove('hidden');
            
            // åˆ›å»ºç»“æœé¡¹
            const resultItem = document.createElement('div');
            resultItem.className = `result-item ${success ? '' : 'error'}`;
            resultItem.id = `result-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
            
            const icon = success ? 'âœ…' : 'âŒ';
            const time = new Date().toLocaleTimeString();
            
            resultItem.innerHTML = `
                <div class="result-icon">${icon}</div>
                <div class="result-content">
                    <div class="result-filename">${filename}</div>
                    <div class="result-message">${message}</div>
                </div>
                <div class="result-actions">
                    <div class="result-time">${time}</div>
                    <button class="btn btn-sm btn-danger" onclick="deleteUploadResult('${resultItem.id}')" title="åˆ é™¤æ­¤ç»“æœ">
                        Ã—
                    </button>
                </div>
            `;
            
            // æ·»åŠ åˆ°ç»“æœåˆ—è¡¨é¡¶éƒ¨
            resultsList.insertBefore(resultItem, resultsList.firstChild);
        }

        // åˆ é™¤ä¸Šä¼ ç»“æœ
        function deleteUploadResult(resultId) {
            const resultItem = document.getElementById(resultId);
            if (resultItem) {
                resultItem.remove();
                
                // æ£€æŸ¥æ˜¯å¦è¿˜æœ‰ç»“æœï¼Œå¦‚æœæ²¡æœ‰åˆ™éšè—ç»“æœåŒºåŸŸ
                const resultsList = document.getElementById('resultsList');
                if (resultsList.children.length === 0) {
                    const resultsDiv = document.getElementById('uploadResults');
                    resultsDiv.classList.add('hidden');
                }
            }
        }

        // æ¸…ç©ºæ‰€æœ‰ä¸Šä¼ ç»“æœ
        function clearAllUploadResults() {
            if (confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰ä¸Šä¼ ç»“æœå—ï¼Ÿ')) {
                const resultsList = document.getElementById('resultsList');
                resultsList.innerHTML = '';
                const resultsDiv = document.getElementById('uploadResults');
                resultsDiv.classList.add('hidden');
            }
        }

        // åŠ è½½æ–‡æ¡£åˆ—è¡¨
        async function loadDocuments() {
            const documentList = document.getElementById('documentList');
            documentList.innerHTML = `
                <div class="loading-state">
                    <div class="loading"></div>
                    <span>åŠ è½½æ–‡æ¡£åˆ—è¡¨ä¸­...</span>
                </div>
            `;

            try {
                const response = await authenticatedFetch(`./kb/api/knowledge-base/${encodeURIComponent(currentKnowledgeBase)}/documents`);
                const data = await response.json();

                if (data.success) {
                    displayDocuments(data.data.documents || []);
                } else {
                    documentList.innerHTML = `
                        <div class="empty-documents">
                            <div class="icon">âŒ</div>
                            <p>åŠ è½½æ–‡æ¡£åˆ—è¡¨å¤±è´¥: ${data.message}</p>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('åŠ è½½æ–‡æ¡£åˆ—è¡¨å¤±è´¥:', error);
                documentList.innerHTML = `
                    <div class="empty-documents">
                        <div class="icon">âŒ</div>
                        <p>åŠ è½½æ–‡æ¡£åˆ—è¡¨å¤±è´¥: ${error.message}</p>
                    </div>
                `;
            }
        }

        // æ˜¾ç¤ºæ–‡æ¡£åˆ—è¡¨
        function displayDocuments(documents) {
            const documentList = document.getElementById('documentList');
            
            if (documents.length === 0) {
                documentList.innerHTML = `
                    <div class="empty-documents">
                        <div class="icon">ğŸ“„</div>
                        <p>æš‚æ— æ–‡æ¡£</p>
                    </div>
                `;
                return;
            }

            // å¤„ç†æ–‡æ¡£æ•°æ® - å¯èƒ½æ˜¯å­—ç¬¦ä¸²æ•°ç»„æˆ–å¯¹è±¡æ•°ç»„
            const processedDocs = documents.map(doc => {
                if (typeof doc === 'string') {
                    return { name: doc, chunks: 0 };
                }
                return doc;
            });

            documentList.innerHTML = processedDocs.map(doc => `
                <div class="document-item">
                    <div class="document-info">
                        <div class="document-icon">${getDocumentIcon(doc.name)}</div>
                        <div class="document-details">
                            <div class="document-name">${doc.name}</div>
                            <div class="document-meta">
                                <span>ç±»å‹: ${getDocumentType(doc.name)}</span>
                                ${doc.chunks ? `<span>å—æ•°: ${doc.chunks}</span>` : ''}
                            </div>
                        </div>
                    </div>
                    <div class="document-actions">
                        <button class="btn btn-sm btn-secondary" onclick="previewDocument('${doc.name}')">
                            é¢„è§ˆ
                        </button>
                        <button class="btn btn-sm btn-danger" onclick="deleteDocument('${doc.name}')">
                            åˆ é™¤
                        </button>
                    </div>
                </div>
            `).join('');
        }

        // è·å–æ–‡æ¡£å›¾æ ‡
        function getDocumentIcon(fileName) {
            const ext = fileName.toLowerCase().split('.').pop();
            const icons = {
                'pdf': 'ğŸ“„',
                'md': 'ğŸ“',
                'txt': 'ğŸ“„',
                'doc': 'ğŸ“„',
                'docx': 'ğŸ“„'
            };
            return icons[ext] || 'ğŸ“„';
        }

        // è·å–æ–‡æ¡£ç±»å‹
        function getDocumentType(fileName) {
            const ext = fileName.toLowerCase().split('.').pop();
            const types = {
                'pdf': 'PDFæ–‡æ¡£',
                'md': 'Markdown',
                'txt': 'çº¯æ–‡æœ¬',
                'doc': 'Wordæ–‡æ¡£',
                'docx': 'Wordæ–‡æ¡£'
            };
            return types[ext] || 'æœªçŸ¥ç±»å‹';
        }

        // åˆ é™¤æ–‡æ¡£
        async function deleteDocument(documentName) {
            if (!confirm(`ç¡®å®šè¦åˆ é™¤æ–‡æ¡£ "${documentName}" å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚`)) {
                return;
            }

            try {
                const response = await authenticatedFetch('./kb/api/delete', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        knowledge_base_name: currentKnowledgeBase,
                        document_name: documentName,
                        delete_type: 'document'
                    })
                });

                const result = await response.json();

                if (result.success) {
                    showStatus(`æ–‡æ¡£ "${documentName}" åˆ é™¤æˆåŠŸ`, 'success');
                    loadDocuments(); // é‡æ–°åŠ è½½æ–‡æ¡£åˆ—è¡¨
                } else {
                    showStatus(`åˆ é™¤å¤±è´¥: ${result.message}`, 'error');
                }
            } catch (error) {
                console.error('åˆ é™¤æ–‡æ¡£å¤±è´¥:', error);
                showStatus(`åˆ é™¤å¤±è´¥: ${error.message}`, 'error');
            }
        }
    </script>
</body>
</html>
